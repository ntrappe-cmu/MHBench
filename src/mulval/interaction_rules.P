% =============================================================================
% MulVAL Interaction Rules for MHBench
% =============================================================================
%
% This file defines HOW ATTACKS COMPOSE — it is universal across all MHBench
% environments. You should NOT need to modify it per-environment.
%
% It is paired with a per-environment facts file (input.P) that describes a
% specific network topology. The facts file is generated automatically by
% mulval_exporter.py from an MHBench NetworkTopology object.
%
% How these two files relate:
%
%   interaction_rules.P (this file)     input.P (generated per-environment)
%   --------------------------------    ------------------------------------
%   "If a host has a remote exploit     "webserver has CVE-2017-5638 in httpd"
%    AND the attacker can reach it,      "attacker can reach webserver on tcp/8080"
%    THEN the attacker gets code exec"   "httpd runs on webserver at tcp/8080 as root"
%
%   Generic inference logic             Specific environment facts
%   Shared across ALL environments      Unique to each topology
%   Rarely changes                      Generated fresh each time
%
% The rules cover these attack patterns:
%   - Remote exploitation of server programs  (execCode via remoteExploit)
%   - Local privilege escalation              (execCode root via localExploit)
%   - Multi-hop network pivoting              (netAccess via hacl + execCode)
%   - Principal compromise propagation        (compromised user → other hosts)
%   - SSH/VPN login services                  (logInService via sshd/vpnService)
%   - NFS file access                         (not currently used by MHBench)
%   - Trojan horse via file write             (not currently used by MHBench)
%   - Client-side exploits via malicious web  (not currently used by MHBench)
%
% MHBench vulnerability types and which rules they trigger:
%
%   ApacheStrutsVulnerability   → remoteExploit → "remote exploit of a server program"
%   NetcatShellVulnerability    → remoteExploit → "remote exploit of a server program"
%   MisconfiguredSSHKeys        → remoteExploit → "remote exploit of a server program"
%   SudoBaronVulnerability      → localExploit  → "local exploit"
%   WriteablePasswdVulnerability→ localExploit  → "local exploit"
%
% When to modify this file:
%   - You add a fundamentally NEW attack category to MHBench (e.g., supply chain,
%     DNS rebinding, timing side-channel) that doesn't fit the existing
%     remoteExploit/localExploit model.
%   - You do NOT need to modify this file when adding new vulnerability instances
%     (new CVEs, new Ansible playbooks). Those only need an entry in the
%     VULN_LOOKUP table in mulval_exporter.py.
%
% Original authors: Xinming Ou, Su Zhang
% Original source:  MulVAL (Argus Cybersecurity Lab, Kansas State University)
% =============================================================================

% MulVAL interaction rules
% Author : Xinming Ou, Su Zhang
% Copyright (C) 2011, Argus Cybersecurity Lab, Kansas State University

% This program is free software: you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation, either version 3 of the License, or
% (at your option) any later version.
% 
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
% 
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.

/******************************************************/
/****         Predicates Declaration              *****/
/******************************************************/

primitive(inCompetent(_principal)).
primitive(competent(_principal)).
primitive(clientProgram(_host, _programname)).
primitive(vulExists(_host, _vulID, _program)).
primitive(vulProperty(_vulID, _range, _consequence)).
primitive(hacl(_src, _dst, _prot, _port)).
primitive(attackerLocated(_host)).
primitive(hasAccount(_principal, _host, _account)).
primitive(networkServiceInfo(_host, _program, _protocol, _port, _user)).
primitive(setuidProgramInfo(_host, _program, _owner)).
primitive(nfsExportInfo(_server, _path, _access, _client)).
primitive(nfsMounted(_client, _clientpath, _server, _serverpath, _access)).
primitive(localFileProtection(_host, _user, _access, _path)).
primitive(dependsOn(_h, _program, _library)).
primitive(installed(_h, _program)).
primitive(bugHyp(_,_,_,_)).
primitive(vulExists(_machine,_vulID,_program,_range,_consequence)).
primitive(canAccessFile(_host, _user, _access, _path)).
primitive(isWebServer(_host)).
meta(cvss(_vulID, _ac)).


derived(execCode(_host, _user)).
derived(netAccess(_machine,_protocol,_port)).
derived(canAccessHost(_host)).
derived(accessFile(_machine,_access,_filepath)).
derived(accessMaliciousInput(_host, _principal, _program)).
derived(principalCompromised(_victim)).
derived(dos(_host)).
derived(logInService(_host, _protocol, _port)).

meta(attackGoal(_)).
meta(advances(_, _)).

/******************************************************/
/****         Tabling Predicates                  *****/
/*   All derived predicates should be tabled          */
/******************************************************/

:- table execCode/2.
:- table netAccess/3.
:- table canAccessHost/1.
:- table canAccessFile/4.
:- table accessFile/3.
:- table principalCompromised/1.
:- table vulExists/5.
:- table logInService/3.



/******************************************************/
/****         Interaction Rules                   *****/
/******************************************************/

% =============================================================================
% Section: execCode
% These rules determine how an attacker gains code execution on a host.
% =============================================================================

/****** Insider threat (disabled by default) ******
interaction_rule(
   (execCode(H, Perm) :-
	hasAccount(P, H, Perm)),
   rule_desc('Insider threat', 1)).
*/

% Compromised principal can access any host they have an account on.
% MHBench note: this is why we namespace usernames in the facts file.
% Without namespacing, generic names like "user_0" on different hosts
% would be treated as the same principal, causing false propagation.
interaction_rule(
   (execCode(Host, Perm) :-
	principalCompromised(Victim),
	hasAccount(Victim, Host, Perm),
	canAccessHost(Host)),
   rule_desc('When a principal is compromised any machine he has an account on will also be compromised',
   0.5)).

% Local privilege escalation: if attacker has any access to a host AND
% the host has a localExploit vulnerability, attacker gets root.
% MHBench vulns that trigger this: SudoBaronVulnerability, WriteablePasswdVulnerability
interaction_rule(
  (execCode(Host, root) :-
	execCode(Host, _Perm2),
	vulExists(Host, _, Software, localExploit, privEscalation)),
  rule_desc('local exploit',
  1.0)).

% Remote exploitation: if a host runs a vulnerable network service AND
% the attacker has network access to it, attacker gets code execution.
% MHBench vulns that trigger this: ApacheStruts, NetcatShell, MisconfiguredSSHKeys
interaction_rule(
  (execCode(H, Perm) :-
	vulExists(H, _, Software, remoteExploit, privEscalation),
	networkServiceInfo(H, Software, Protocol, Port, Perm),
	netAccess(H, Protocol, Port)),
  rule_desc('remote exploit of a server program',
  1.0)).

% Remote client-side exploit (e.g., browser exploit via malicious page).
% Not currently used by MHBench but kept for completeness.
interaction_rule(
  (execCode(H, Perm) :-
        vulExists(H, _, Software, remoteClient, privEscalation),
	hasAccount(Victim, H, Perm),
        accessMaliciousInput(H, Victim, Software)),
  rule_desc('remote exploit for a client program',
  0.5)).

% Trojan horse: if attacker can write to a file, they can get root.
% Not currently triggered by MHBench facts but kept for completeness.
interaction_rule(
  (execCode(H, root) :-
	accessFile(H, write, _Path)),
  rule_desc('Trojan horse installation',
  0.8)).


% =============================================================================
% Section: netAccess
% These rules determine how an attacker reaches a host over the network.
% =============================================================================

% Multi-hop pivoting: attacker has code execution on one host and uses
% it to reach another host via allowed network paths (hacl).
% This is the core lateral movement mechanism in MulVAL.
interaction_rule(
  (netAccess(H2, Protocol, Port) :-
	execCode(H1, _Perm),  /* Any permission level */
	advances(H1, H2),
    hacl(H1, H2, Protocol, Port)),
  rule_desc('multi-hop access',
  0.5)).

% Direct access from the attacker's location (internet).
% Combined with hacl(internet, host, _, _) facts from the exporter,
% this gives the attacker initial network access to external-facing hosts.
interaction_rule(
  (netAccess(H, Protocol, Port) :-
	attackerLocated(Zone),
	hacl(Zone, H, Protocol, Port)),
  rule_desc('direct network access',
  1.0)).

% If attacker is already on a host, they have full local network access.
interaction_rule(
  (netAccess(H, Protocol, Port) :-
	attackerLocated(H)),
  rule_desc('direct on-host access',
  1.0)).


% =============================================================================
% Section: canAccessHost
% These rules determine whether the attacker can interact with a host.
% =============================================================================

interaction_rule(
  (canAccessHost(H) :-
	execCode(H, _Perm)),
  rule_desc('Access a host through executing code on the machine',
  1.0)).

interaction_rule(
  (canAccessHost(H) :-
	logInService(H, Protocol, Port),
	netAccess(H, Protocol, Port)),
  rule_desc('Access a host through a log-in service',
  1.0)).


% =============================================================================
% Section: accessFile
% =============================================================================

interaction_rule(
  (accessFile(H, Access, Path) :-
	execCode(H, Usr),
	canAccessFile(H, Usr, Access, Path)),
  rule_desc('execCode implies file access',
  1.0)).


% =============================================================================
% Section: principalCompromised
% If the attacker has root or user-level access on a host, they can
% compromise any principal (user) who has an account on that host.
% =============================================================================

interaction_rule(
  (principalCompromised(Victim) :-
	hasAccount(Victim, H, _Perm),
	execCode(H, root)),
  rule_desc('password sniffing',
  0.8)).

interaction_rule(
  (principalCompromised(Victim) :-
	hasAccount(Victim, H, User),
	execCode(H, User)),
  rule_desc('password sniffing',
  0.8)).

/*
interaction_rule(
  (principalCompromised(Victim) :-
	inCompetent(Victim)),
  rule_desc('incompetent user',
  0.2)).
*/



/********************************************************/
/*      Software specific knowledge                     */
/********************************************************/

% =============================================================================
% Section: Login services (SSH, VPN)
% If a host runs sshd or vpnService, it counts as a login service.
% MHBench note: MisconfiguredSSHKeysVulnerability emits
% networkServiceInfo(host, sshd, tcp, 22, user) which triggers this.
% =============================================================================

interaction_rule(
  (logInService(H, Protocol, Port) :-
	networkServiceInfo(H, sshd, Protocol, Port, _)),
  rule_desc('',
  1)).

interaction_rule(
  (logInService(H, Protocol, Port) :-
	networkServiceInfo(H, vpnService, Protocol, Port, _)),
  rule_desc('',
  1)).


% =============================================================================
% Section: NFS
% Not currently used by MHBench (no NFS in generated environments).
% Kept for compatibility with standard MulVAL.
% =============================================================================

interaction_rule(
  (accessFile(Server, Access, ServerPath) :-
	nfsMounted(Client, ClientPath, Server, ServerPath, Access),
	accessFile(Client, Access, ClientPath)),
  rule_desc('NFS semantics',
  1)).

interaction_rule(
  (accessFile(Client, Access, ClientPath) :-
	nfsMounted(Client, ClientPath, Server, ServerPath, read),
	accessFile(Server, Access, ServerPath)),
  rule_desc('NFS semantics',
  1)).

interaction_rule(
  (accessFile(Server, Access, Path) :-
	execCode(Client, _User),
    nfsExportInfo(Server, Path, Access, Client),
    hacl(Client, Server, nfsProtocol, nfsPort)),
  rule_desc('NFS shell',
  0.8)).

interaction_rule(
  (canAccessFile(H, Usr, Acc, Path) :-
	localFileProtection(H, Usr, Acc, Path)),
  rule_desc('',
  1)).


% =============================================================================
% Section: Vulnerability expansion
% These rules join vulExists/3 (from facts) with vulProperty/3 (from facts)
% to produce the 5-arity vulExists/5 that the execCode rules consume.
% This is the bridge between what the exporter emits and what the attack
% rules need.
% =============================================================================

interaction_rule((vulExists(H, ID, Sw, Range, Consequence):-
	        vulExists(H, ID, Sw),
		vulProperty(ID, Range, Consequence)),
             rule_desc('',
             1)).

interaction_rule((vulExists(H, _ID, Sw, Range, Consequence):-
	        bugHyp(H, Sw, Range, Consequence)),
             rule_desc('Introducing hypothetical bug',
             1)).

interaction_rule((vulExists(H, ID, Sw, Range, Consequence):-
	        vulExists(H, ID, Library, Range, Consequence),
		dependsOn(H, Sw, Library)),
             rule_desc('Library bug',
             1)).


% =============================================================================
% Section: Malicious input (client-side attacks)
% Not currently used by MHBench but kept for completeness.
% =============================================================================

interaction_rule(
   (accessMaliciousInput(H, Victim, Software) :-
     inCompetent(Victim),
     hacl(H, MaliciousMachine, httpProtocol, httpPort),
     attackerLocated(MaliciousMachine)),
  rule_desc('Browsing a malicious website', 0.8)).

interaction_rule(
   (accessMaliciousInput(H, Victim, Software) :-
     competent(Victim),
     hacl(H, MaliciousMachine, httpProtocol, httpPort),
     attackerLocated(MaliciousMachine)),
  rule_desc('Browsing a malicious website', 0.1)).

interaction_rule(
   (accessMaliciousInput(H, Victim, Software) :-
     inCompetent(Victim),
     isWebServer(CompromisedMachine),
     hacl(H, CompromisedMachine, httpProtocol, httpPort),
     execCode(CompromisedMachine, _)),
  rule_desc('Browsing a compromised website', 0.4)).
